<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Inventaris Lab Komputer 2 ‚Äî Realtime</title>
<style>
    body { font-family: 'Calibri', sans-serif; background:#f4f7fb; padding:20px; margin:0; }
    .header { background:#0056b3; padding:15px 25px; color:white; font-size:28px; font-weight:bold; border-left:10px solid #ffcc00; width:fit-content; border-radius:5px;}
    .card-container { display:grid; grid-template-columns:repeat(3,260px); gap:15px; margin-top:20px; }
    .card { background:white; border-left:6px solid #ffcc00; padding:15px; border-radius:8px; box-shadow:0 3px 6px rgba(0,0,0,0.15); font-size:18px;}
    .card-title { color:#0056b3; font-weight:bold; }

    #mapGrid { display:grid; grid-template-columns:repeat(11,55px); gap:6px; margin-top:30px; margin-bottom:40px; }
    .meja { width:55px; height:45px; border-radius:6px; font-weight:bold; display:flex; justify-content:center; align-items:center; cursor:pointer; user-select:none; }
    .normal { background:#28a745; color:white; }
    .ringan { background:#ffc107; color:black; }
    .berat  { background:#dc3545; color:white; }
    .signed { background:#007bff !important; color:white !important; }
    .marked { background:#7a00ff !important; color:white !important; }
    .empty  { background:#c4c4c4 !important; color:#555 !important; }
    .kosong { background:transparent; border:none; cursor:default; }

    #detailBox { background:white; width:360px; padding:18px; border-radius:8px; box-shadow:0 3px 8px rgba(0,0,0,0.2); display:none; position:fixed; right:24px; top:120px; z-index:60; }
    #detailBox h3 { margin-top:0; color:#0056b3; border-left:6px solid #ffcc00; padding-left:8px; }

    .btn { display:inline-block; padding:8px 12px; border-radius:6px; border:1px solid #0056b3; cursor:pointer; background:white; color:#0056b3; font-weight:bold; }
    .btn-ghost { background:transparent; border:1px solid #ddd; color:#333; }
    .btn-primary { background:#007bff; color:white; border:none; }
    .btn-mark { background:#7a00ff; color:white; border:none; }
    .btn-reset { background:#ff3399; color:white; border:none; }
    .btn-download { background:#00aa55; color:white; border:none; }

    #adminControl { position:fixed; top:12px; right:12px; z-index:9999; display:flex; gap:8px; align-items:center; }
    #btnLogin,#btnLogout { background:#6436ff; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:bold; font-size:13px; box-shadow:0 0 8px rgba(0,0,0,0.15); }
    #btnLogout { background:#e91e63; }
    .small { font-size:13px; color:#444; }

    .notes { font-size:13px; color:#444; margin-top:6px; }
    pre.smallbox { background:#f5f7fa; padding:8px; border-radius:6px; overflow:auto; max-height:160px; }

    @media (max-width:900px){
        .card-container { grid-template-columns:repeat(1,1fr); }
        #mapGrid { grid-template-columns:repeat(6,55px); }
        #detailBox { position:static; width:auto; margin-top:20px; left:12px; right:12px; }
    }
</style>
</head>
<body>

<div class="header">üìò Dashboard Inventaris Lab Komputer ‚Äî Realtime</div>

<!-- Floating admin control -->
<div id="adminControl">
    <button id="btnLogin" onclick="promptLogin()">Masuk Admin</button>
    <button id="btnLogout" onclick="logoutAdmin()" style="display:none;">Keluar</button>
    <button id="btnSyncInv" class="btn" onclick="uploadInventaris()" style="display:none;">Sync Inventaris ‚Üí Server</button>
    <button id="btnFetchInv" class="btn" onclick="forceFetchInventaris()" style="display:none;">Fetch Inventaris Server</button>
</div>

<!-- Action buttons (admin-only) -->
<div style="margin-top:14px;margin-bottom:6px;">
    <button id="resetSigns" class="btn btn-reset">Reset Semua Sign-In</button>
    <button id="resetMarkBtn" class="btn btn-reset">Reset Semua Tanda Masalah</button>
    <button id="downloadLog" class="btn btn-download">Download Log</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="card-container" style="margin-bottom:10px;">
    <div class="card"><div class="card-title">Total Perangkat</div><span id="totalPerangkat">-</span></div>
    <div class="card"><div class="card-title">Jumlah Windows</div><span id="totalWindows">-</span></div>
    <div class="card"><div class="card-title">Jumlah Chromebook</div><span id="totalChromebook">-</span></div>

    <div class="card"><div class="card-title">Perangkat Normal</div><span id="normalCount">-</span></div>
    <div class="card"><div class="card-title">Rusak Ringan</div><span id="ringanCount">-</span></div>
    <div class="card"><div class="card-title">Rusak Berat</div><span id="beratCount">-</span></div>

    <div class="card"><div class="card-title">Kebutuhan Mouse</div><span id="mouseNeed">-</span></div>
    <div class="card"><div class="card-title">Kebutuhan Keyboard</div><span id="keyboardNeed">-</span></div>
</div>

<h2 style="color:#0056b3;margin-top:8px;">üìç Peta Meja Lab</h2>
<div id="mapGrid"></div>

<div id="detailBox"></div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<!-- XLSX lib (kept if you want to support Excel upload later) -->
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<script>
/* ================= CONFIG ================= */
const ADMIN_PIN = "17081945";
let isAdmin = false;

/* Firebase config (keep or replace with your own) */
const firebaseConfig = {
  apiKey: "AIzaSyBr-nd0dxZl5q6DLPxMKLybJ7MyBc9kaBc",
  authDomain: "realtime-database-f59b8.firebaseapp.com",
  databaseURL: "https://realtime-database-f59b8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "realtime-database-f59b8",
  storageBucket: "realtime-database-f59b8.firebasestorage.app",
  messagingSenderId: "320982155387",
  appId: "1:320982155387:web:df67817761e282dee4a2de"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* WIFI & CHROME ACCOUNTS (same mapping as before) */
const WIFI = {};
for (let i=1;i<=40;i++){ WIFI[i] = { user: `${i}lab2`, pass: String(i) }; }
const CHROME_ACCOUNTS = [
"putri.wika67@smp.belajar.id","kallista.putri192@smp.belajar.id","yulia.al83@smp.belajar.id",
"nazril.hidayatullah18@smp.belajar.id","muhammad.febri1219@smp.belajar.id","muhamad.rizkan48@smp.belajar.id",
"safania.52@smp.belajar.id","nia.hidayati013@smp.belajar.id","nayilla_azzahra25@smp.belajar.id",
"widya.setya31@smp.belajar.id","yusuf.fahreza18@smp.belajar.id","muhamad.arif3591@smp.belajar.id",
"muhamad.faiz3380@smp.belajar.id","muhammad.khairul8017@smp.belajar.id","aisyatul.maulida49@smp.belajar.id"];
const CHROME_PASS = "Belajar2025!";

/* local keys fallback */
const LS_SIGNED = "lab2_signed";
const LS_MARK = "lab2_marked";
const LS_LOG_PREF = "lab2_local_logs";
let LOCAL_LOGS = JSON.parse(localStorage.getItem(LS_LOG_PREF) || "[]");
let SIGNED = JSON.parse(localStorage.getItem(LS_SIGNED) || "{}");
let MARKED = JSON.parse(localStorage.getItem(LS_MARK) || "{}");

/* helper log */
function pushLocalLog(entry){
    LOCAL_LOGS.push(entry);
    localStorage.setItem(LS_LOG_PREF, JSON.stringify(LOCAL_LOGS));
}

/* ================= INVENTARIS (embedded from your data) =================
   Local default inventaris ‚Äî server dapat menimpa ini jika ada data server.
*/
const LOCAL_INVENTARIS = [
  {no:1,  inventaris:"29", merek:"AXIO L19B", os:"Chromebook", kondisi:"Normal", keterangan:"Normal"},
  {no:2,  inventaris:"XX", merek:"AXIO L19B", os:"Chromebook", kondisi:"Normal", keterangan:"Normal"},
  {no:3,  inventaris:"28", merek:"AXIO L19B", os:"Chromebook", kondisi:"Rusak Ringan", keterangan:"batre kembung"},
  {no:4,  inventaris:"21 (43A)", merek:"LENOVO IDEAPAD 110", os:"Windows 10 Pro 64 bit", kondisi:"Rusak Ringan", keterangan:"Normal, kadang suka ga masuk windows"},
  {no:5,  inventaris:"20", merek:"AXIO L19B", os:"Chromebook", kondisi:"Normal", keterangan:"Normal"},
  {no:6,  inventaris:"21", merek:"AXIO L19B", os:"Chromebook", kondisi:"Normal", keterangan:"Normal"},
  {no:7,  inventaris:"26", merek:"AXIO L19B", os:"Chromebook", kondisi:"Normal", keterangan:"Normal"},
  {no:8,  inventaris:"XX", merek:"AXIO L19B", os:"Chromebook", kondisi:"Normal", keterangan:"Normal"},
  {no:9,  inventaris:"23", merek:"AXIO L19B", os:"Chromebook", kondisi:"Normal", keterangan:"Normal"},
  {no:10, inventaris:"XX", merek:"AXIO L19B", os:"Chromebook", kondisi:"Normal", keterangan:"Normal"},
  {no:11, inventaris:"17", merek:"AXIO L19B", os:"Chromebook", kondisi:"Normal", keterangan:"Normal"},
  {no:12, inventaris:"18", merek:"AXIO L19B", os:"Chromebook", kondisi:"Normal", keterangan:"Normal"},
  {no:13, inventaris:"38", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Rusak Berat", keterangan:"Normal, Trackpad Klik"},
  {no:14, inventaris:"35", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Normal", keterangan:"Normal"},
  /* 15,16 empty */
  {no:17, inventaris:"6", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Rusak Ringan", keterangan:"Normal, Trackpad Klik"},
  {no:18, inventaris:"8", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Rusak Ringan", keterangan:"Normal, Trackpad Klik"},
  {no:19, inventaris:"XX", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Rusak Ringan", keterangan:"Normal, Driver Wifi Error"},
  {no:20, inventaris:"24", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Normal", keterangan:"Normal"},
  {no:21, inventaris:"5", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Normal", keterangan:"Normal"},
  {no:22, inventaris:"22", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Rusak Berat", keterangan:"Normal, Trackpad Klik, Keyboard Error"},
  {no:23, inventaris:"25", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Rusak Berat", keterangan:"Normal, Keyboard error"},
  {no:24, inventaris:"3", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Rusak Berat", keterangan:"Normal, Trackpad Klik"},
  {no:25, inventaris:"15", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64LBR", kondisi:"Rusak Ringan", keterangan:"Normal, Trackpad Klik"},
  {no:26, inventaris:"26", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Normal", keterangan:"Normal"},
  {no:27, inventaris:"27", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Normal", keterangan:"Normal"},
  {no:28, inventaris:"28", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Normal", keterangan:"Normal"},
  {no:29, inventaris:"29", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", condition:"Normal", keterangan:"Normal"},
  {no:30, inventaris:"11", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Normal", keterangan:"Normal"},
  {no:31, inventaris:"31", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Normal", keterangan:"Normal"},
  {no:32, inventaris:"XX", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Normal", keterangan:"Normal"},
  {no:33, inventaris:"33", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Rusak Berat", keterangan:"Normal, Trackpad Klik, Keyboard Error"},
  {no:34, inventaris:"XX", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Rusak Berat", keterangan:"Normal, Trackpad Klik, Keyboard Error"},
  {no:35, inventaris:"1", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Normal", keterangan:"Normal"},
  /* 36,37 empty */
  {no:38, inventaris:"12", merek:"LENOVO IDEAPAD 110 14LBR", os:"Windows 10 Pro 64 bit", kondisi:"Normal", keterangan:"Normal"}
  /* 39,40 empty */
];

/* runtime inven map that UI uses (will be filled from server or local) */
let INVENTARIS = [];
const INV_MAP = {}; // built from INVENTARIS for fast lookup

/* ================= Firebase path helpers ================= */
function dbPathSigned(no){ return `/lab2/signed/${no}`; }
function dbPathMarked(no){ return `/lab2/marked/${no}`; }
function dbPathLogs(dateStr){ return `/lab2/logs/${dateStr}`; }
function dbPathAllLogs(){ return `/lab2/logs`; }
function dbPathInventaris(){ return `/lab2/inventaris`; }

/* ================= UI Helpers ================= */
function setAdminUI(){
    document.getElementById("btnLogin").style.display = isAdmin ? "none" : "inline-block";
    document.getElementById("btnLogout").style.display = isAdmin ? "inline-block" : "none";
    document.getElementById("btnSyncInv").style.display = isAdmin ? "inline-block" : "none";
    document.getElementById("btnFetchInv").style.display = isAdmin ? "inline-block" : "none";
    document.querySelectorAll("#resetSigns,#resetMarkBtn,#downloadLog").forEach(b => b.style.display = isAdmin ? "inline-block" : "inline-block"); // download allowed to everyone
}

/* ================= Dashboard Counts & Render ================= */
function updateDashboardCounts(){
    const deviceCount = INVENTARIS.length;
    let win = INVENTARIS.filter(x => (x.os||"").toLowerCase().includes("windows")).length;
    let chrome = INVENTARIS.filter(x => (x.os||"").toLowerCase().includes("chrome")).length;
    document.getElementById("totalPerangkat").innerText = deviceCount;
    document.getElementById("totalWindows").innerText = win;
    document.getElementById("totalChromebook").innerText = chrome;
    document.getElementById("normalCount").innerText = INVENTARIS.filter(x => (x.kondisi||"").toLowerCase()==="normal").length;
    document.getElementById("ringanCount").innerText = INVENTARIS.filter(x => (x.kondisi||"").toLowerCase().includes("ringan")).length;
    document.getElementById("beratCount").innerText = INVENTARIS.filter(x => (x.kondisi||"").toLowerCase().includes("berat")).length;
    // placeholders
    document.getElementById("mouseNeed").innerText = 0;
    document.getElementById("keyboardNeed").innerText = 0;
}

function buildInvMap(){
    Object.keys(INV_MAP).forEach(k=> delete INV_MAP[k]);
    INVENTARIS.forEach(it => { INV_MAP[String(it.no)] = it; });
}

/* render map grid based on a fixed layout (same layout as earlier) */
function renderMap(){
    const grid = document.getElementById("mapGrid");
    grid.innerHTML = "";
    const rows = [
      [22,21,20,19,18,17,"",4,3,2,1],
      [28,27,26,25,24,23,"",8,7,6,5],
      [34,33,32,31,30,29,"",12,11,10,9],
      [40,39,38,37,36,35,"",16,15,14,13]
    ];
    rows.forEach(row=>{
        row.forEach(no=>{
            const div = document.createElement("div");
            if(no === ""){
                div.className = "meja kosong"; grid.appendChild(div); return;
            }
            const item = INV_MAP[String(no)];
            let cls;
            if(MARKED[String(no)]) cls = "marked";
            else if(SIGNED[String(no)]) cls = "signed";
            else {
                if(item){
                    const k = (item.kondisi || "").toLowerCase();
                    if(k.includes("berat")) cls = "berat";
                    else if(k.includes("ringan")) cls = "ringan";
                    else cls = "normal";
                } else {
                    cls = "empty";
                }
            }
            div.className = "meja " + cls;
            div.textContent = no;
            div.onclick = ()=> showDetail(no);
            grid.appendChild(div);
        });
    });
    updateDashboardCounts();
    setAdminUI();
}

/* ================= Detail popup ================= */
function showDetail(no){
    const box = document.getElementById("detailBox");
    box.style.display = "block";
    const item = INV_MAP[String(no)];
    if(!item){
        box.innerHTML = `<h3>Detail Meja ${no}</h3><div class="small">Data inventaris tidak ditemukan untuk meja ini.</div><div style="margin-top:12px;"><button id="btnClose" class="btn btn-ghost">Tutup</button></div>`;
        document.getElementById("btnClose").onclick = ()=> box.style.display='none';
        return;
    }

    const wifi = WIFI[no] || {user:"-", pass:"-"};
    const isChrome = (item.os||"").toLowerCase().includes("chrome");
    const belajarUser = isChrome ? CHROME_ACCOUNTS[(no-1) % CHROME_ACCOUNTS.length] : "-";
    const markedNote = (MARKED[String(no)] && MARKED[String(no)].note) ? MARKED[String(no)].note : (item.keterangan || "-");
    const signedNow = !!SIGNED[String(no)];

    box.innerHTML = `
        <h3>Detail Meja ${no}</h3>
        <b>No Inventaris:</b> ${item.inventaris || "-"}<br>
        <b>Merek / Tipe:</b> ${item.merek || "-"}<br>
        <b>OS:</b> ${item.os || "-"}<br>
        <b>Kondisi:</b> ${item.kondisi || "-"}<br>
        <b>Keterangan:</b> ${item.keterangan || "-"}<br><br>

        <div class="small"><b>Akun WiFi (LAB 2)</b></div>
        <b>Username:</b> ${wifi.user}<br>
        <b>Password:</b> ${wifi.pass}<br><br>

        <div class="small"><b>Akun Belajar.ID (jika Chromebook)</b></div>
        <b>Email:</b> ${isChrome ? belajarUser : "-"}<br>
        <b>Password:</b> ${isChrome ? CHROME_PASS : "-"}<br><br>

        <b>Status Signed:</b> ${signedNow ? "Sudah" : "Belum"}<br>
        <b>Catatan Mark:</b> ${markedNote}<br>

        <div style="margin-top:12px;">
            <button id="btnSign${no}" class="btn btn-primary btn-sign" style="margin-right:8px;">${signedNow ? "‚úî Tandai Ulang Sign-In" : "‚úî Tandai Sudah Sign-In"}</button>
            <button id="btnMark${no}" class="btn btn-mark" style="margin-right:8px;">üö© Tandai Masalah</button>
            <button id="btnClose" class="btn btn-ghost">Tutup</button>
        </div>
    `;
    document.getElementById("btnClose").onclick = ()=> box.style.display='none';

    // buttons behaviour: require admin to change
    document.getElementById(`btnSign${no}`).onclick = async ()=>{
        if(!isAdmin){ alert("Hanya Admin yang dapat mengubah status sign-in."); return; }
        const key = String(no);
        try{
            const newVal = !SIGNED[key];
            if(newVal){
                const payload = { time: Date.now(), by: "admin" };
                await db.ref(dbPathSigned(key)).set(payload);
                SIGNED[key] = payload;
                await db.ref(dbPathLogs(new Date().toISOString().split("T")[0])).push({ time: Date.now(), action: "Signed in (admin)", meja: key });
            } else {
                await db.ref(dbPathSigned(key)).remove();
                delete SIGNED[key];
                await db.ref(dbPathLogs(new Date().toISOString().split("T")[0])).push({ time: Date.now(), action: "Sign-in removed (admin)", meja: key });
            }
        }catch(e){
            // fallback local
            SIGNED[key] = !SIGNED[key];
            localStorage.setItem(LS_SIGNED, JSON.stringify(SIGNED));
            pushLocalLog({ time: Date.now(), action: SIGNED[key] ? "Signed in (admin) (local fallback)" : "Sign-in removed (admin) (local fallback)", meja:key });
        }
        box.style.display='none';
        renderMap();
    };

    document.getElementById(`btnMark${no}`).onclick = async ()=>{
        if(!isAdmin){ alert("Hanya Admin yang dapat menandai masalah."); return; }
        const note = prompt("Tuliskan kendala / catatan untuk meja " + no + " :");
        if(!note) return;
        const key = String(no);
        try{
            const payload = { note, time: Date.now(), by: "admin" };
            await db.ref(dbPathMarked(key)).set(payload);
            MARKED[key] = payload;
            await db.ref(dbPathLogs(new Date().toISOString().split("T")[0])).push({ time: Date.now(), meja: key, action: "Marked: " + note });
        }catch(e){
            MARKED[key] = { note, time: Date.now(), by:"local-fallback" };
            localStorage.setItem(LS_MARK, JSON.stringify(MARKED));
            pushLocalLog({ time: Date.now(), meja:key, action: "Marked (local fallback): " + note });
        }
        box.style.display='none';
        renderMap();
    };

    // update admin controls visibility
    setAdminUI();
}

/* ================= Reset & Download (admin-sensitive) ================= */
document.getElementById("resetSigns").onclick = async ()=>{
    if(!isAdmin){ alert("Hanya Admin yang dapat mereset sign-in."); return; }
    if(!confirm("Reset semua status Sign-In?")) return;
    try{
        await db.ref('/lab2/signed').set(null);
        await db.ref(dbPathLogs(new Date().toISOString().split("T")[0])).push({ time: Date.now(), action: "Reset all signs (admin)"});
        SIGNED = {};
        localStorage.setItem(LS_SIGNED, JSON.stringify(SIGNED));
        renderMap(); alert("Semua sign-in direset (server).");
    }catch(e){
        SIGNED = {}; localStorage.setItem(LS_SIGNED, JSON.stringify(SIGNED));
        pushLocalLog({time:Date.now(), action:"Reset all signs (local fallback)"});
        renderMap(); alert("Server error ‚Äî reset dilakukan lokal (fallback).");
    }
};

document.getElementById("resetMarkBtn").onclick = async ()=>{
    if(!isAdmin){ alert("Hanya Admin yang dapat mereset tanda masalah."); return; }
    if(!confirm("Reset semua tanda masalah (tidak akan menghapus log)?")) return;
    try{
        await db.ref('/lab2/marked').set(null);
        await db.ref(dbPathLogs(new Date().toISOString().split("T")[0])).push({ time: Date.now(), action: "Reset all marks (admin)"});
        MARKED = {};
        localStorage.removeItem(LS_MARK);
        renderMap(); alert("Semua tanda masalah dihapus (server).");
    }catch(e){
        MARKED = {}; localStorage.removeItem(LS_MARK);
        pushLocalLog({time:Date.now(), action:"Reset all marks (local fallback)"});
        renderMap(); alert("Server error ‚Äî reset tanda dilakukan lokal (fallback).");
    }
};

/* Download log: fetch all server logs (all dates), fallback combine local logs */
document.getElementById("downloadLog").onclick = async ()=>{
    const combineLogs = [];
    try{
        const snap = await db.ref(dbPathAllLogs()).once('value');
        const obj = snap.val();
        if(obj){
            // obj is { 'YYYY-MM-DD': { pushid: {time,action,meja}, ... }, ... }
            Object.keys(obj).forEach(dateKey=>{
                const dayObj = obj[dateKey];
                Object.keys(dayObj).forEach(pushId=>{
                    const it = dayObj[pushId];
                    combineLogs.push({ date: dateKey, time: it.time || 0, meja: it.meja || '-', action: it.action || '-' });
                });
            });
        }
    }catch(e){
        // ignore ‚Äî will fallback to local logs only later
    }
    // add local logs (may duplicate some entries)
    if(LOCAL_LOGS && LOCAL_LOGS.length){
        LOCAL_LOGS.forEach(l => {
            combineLogs.push({ date: "-", time: l.time || Date.now(), meja: l.meja || '-', action: l.action || '-' });
        });
    }
    if(combineLogs.length === 0){
        alert("Belum ada log tersedia (server maupun lokal).");
        return;
    }
    // sort by time asc
    combineLogs.sort((a,b)=> (a.time||0) - (b.time||0));
    let text = "TANGGAL | WAKTU | MEJA | ACTION\n\n";
    combineLogs.forEach(c=>{
        const t = new Date(c.time || Date.now()).toLocaleString();
        text += `${c.date} | ${t} | ${c.meja} | ${c.action}\n`;
    });
    const blob = new Blob([text], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `log-all-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
    alert("Download log selesai.");
};

/* ================= Real-time listeners: sync SIGNED & MARKED & INVENTARIS from Firebase if available ================= */
function attachRealtimeListeners(){
    try{
        db.ref('/lab2/signed').on('value', snap=>{
            const v = snap.val() || {};
            SIGNED = v;
            localStorage.setItem(LS_SIGNED, JSON.stringify(SIGNED));
            renderMap();
        });
        db.ref('/lab2/marked').on('value', snap=>{
            const v = snap.val() || {};
            MARKED = v;
            localStorage.setItem(LS_MARK, JSON.stringify(MARKED));
            renderMap();
        });
        db.ref('/lab2/inventaris').on('value', snap=>{
            const v = snap.val();
            if(v && Array.isArray(v)){
                INVENTARIS = v;
                buildInvMap();
                updateDashboardCounts();
                renderMap();
            } else if(v && typeof v === 'object'){
                // allow object keyed by meja no
                const arr = [];
                Object.keys(v).forEach(k=>{
                    const it = v[k];
                    if(it && it.no) arr.push(it);
                });
                if(arr.length) { INVENTARIS = arr; buildInvMap(); renderMap(); }
            } else {
                // no server inventaris ‚Äî keep local
            }
        });
    }catch(e){
        console.warn("Realtime listeners failed (maybe permissions):", e);
    }
}

/* ================= Upload/Download Inventaris ================= */
async function uploadInventaris(){
    if(!isAdmin){ alert("Hanya Admin yang dapat upload inventaris."); return; }
    if(!confirm("Upload inventaris lokal ke server? Ini akan menimpa inventaris server.")) return;
    try{
        // write as array for simplicity
        await db.ref(dbPathInventaris()).set(INVENTARIS);
        await db.ref(dbPathLogs(new Date().toISOString().split("T")[0])).push({ time: Date.now(), action: "Inventaris uploaded (admin)"});
        alert("Inventaris berhasil diupload ke server.");
    }catch(e){
        alert("Gagal upload inventaris: " + (e.message || e));
    }
}

async function forceFetchInventaris(){
    if(!isAdmin){ alert("Hanya Admin yang dapat fetch inventaris server."); return; }
    try{
        const snap = await db.ref(dbPathInventaris()).once('value');
        const v = snap.val();
        if(!v){ alert("Tidak ada inventaris di server."); return; }
        if(Array.isArray(v)) INVENTARIS = v;
        else {
            const arr = []; Object.keys(v).forEach(k=>{ if(v[k] && v[k].no) arr.push(v[k]); });
            INVENTARIS = arr;
        }
        buildInvMap();
        renderMap();
        alert("Inventaris server berhasil diambil.");
    }catch(e){
        alert("Gagal mengambil inventaris server: " + (e.message || e));
    }
}

/* ================= Init & Admin login flow ================= */
function initLocalInventaris(){
    // prefer server-inventaris if present (listener will override), otherwise use local
    INVENTARIS = JSON.parse(JSON.stringify(LOCAL_INVENTARIS)); // clone
    buildInvMap();
}

function promptLogin(){
    const p = prompt("Masukkan PIN Admin:");
    if(p === ADMIN_PIN){ isAdmin = true; alert("Berhasil masuk ADMIN"); setAdminUI(); }
    else alert("PIN salah");
}

function logoutAdmin(){ isAdmin = false; alert("Mode viewer aktif"); setAdminUI(); }

/* ================= Start ================= */
function init(){
    // load local saved signs/marks
    try{ SIGNED = JSON.parse(localStorage.getItem(LS_SIGNED) || "{}"); }catch{}
    try{ MARKED = JSON.parse(localStorage.getItem(LS_MARK) || "{}"); }catch{}
    try{ LOCAL_LOGS = JSON.parse(localStorage.getItem(LS_LOG_PREF) || "[]"); }catch{}
    initLocalInventaris();
    updateDashboardCounts();
    renderMap();
    attachRealtimeListeners();
    setAdminUI();
}
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
